     1 00000000                                 ;---------------------------------------------
     2 00000000                                 ;文件名：boot.nas
     3 00000000                                 ;author:浅握双手
     4 00000000                                 ;时间：2015-9-16
     5 00000000                                 ;功能描述：系统启动 的引导程序
     6 00000000                                 ;---------------------------------------------
     7  = 0000000A                              CYLS	EQU		10			;读入的柱面数
     8 00000000                                 ;---------------------------------------------
     9 00000000                                 
    10                                          	ORG		0x7c00		;启动程序装载地址
    11 00007C00                                 
    12 00007C00 EB 4E                           	JMP		entry		;跳转到程序入口
    13 00007C02 90                              	DB		0x90		;NOP 空指令，
    14 00007C03                                 
    15 00007C03 53 4D 4C 2D 4F 53 20 20         	DB		"SML-OS  "	;启动区的名称,8字符
    16 00007C0B 0200                            	DW		512			;每扇区字节数
    17 00007C0D 01                              	DB		1			;每簇扇区数
    18 00007C0E 0001                            	DW		1			;代表FAT文件分配表之前的引导扇区
    19 00007C10                                 
    20 00007C10 02                              	DB		2			;FAT表的个数
    21 00007C11 00E0                            	DW		224			;根目录 文件最大数
    22 00007C13 0B40                            	DW		2880		;逻辑 扇区 总数
    23 00007C15 F0                              	DB		0xf0		;磁盘种类
    24 00007C16 0009                            	DW		9			;每个FAT占用 多少扇区
    25 00007C18 0012                            	DW		18			;每磁道 扇区数
    26 00007C1A 0002                            	DW		2			;磁头数
    27 00007C1C 00000000                        	DD		0			;隐藏扇区数
    28 00007C20                                 
    29 00007C20 00000B40                        	DD		2880		;如果逻辑扇区总数为0，则在这里记录扇区总数
    30 00007C24 00 00 29                        	DB		0,0,0x29	;中断13的驱动器号，未使用，扩展引导标志
    31 00007C27 FFFFFFFF                        	DD		0Xffffffff	;卷序列号
    32 00007C2B 53 4D 4C 2D 4F 53 20 20 20 20   	DB		"SML-OS     "	;卷标，必须11个字符
       00007C35 20 
    33 00007C36 46 41 54 31 32 20 20 20         	DB		"FAT12   "	; 文件系统类型，必须是8个字符，不足填充空格
    34 00007C3E 00 00 00 00 00 00 00 00 00 00   	RESB	18
       00007C48 00 00 00 00 00 00 00 00 
    35 00007C50                                 	
    36 00007C50                                 ;---------------------------------------------
    37 00007C50                                 ;程序主体入口
    38 00007C50                                 entry:
    39 00007C50 B8 0000                         	MOV		AX,0		;初始化寄存器
    40 00007C53 8E D0                           	MOV		SS,AX
    41 00007C55 BC 7C00                         	MOV 	SP,0x7C00
    42 00007C58 8E D8                           	MOV		DS,AX
    43 00007C5A 8E C0                           	MOV		ES,AX
    44 00007C5C                                 	
    45 00007C5C                                 ;开始加载磁盘内容
    46 00007C5C B8 0820                         	MOV		AX,0X0820
    47 00007C5F 8E C0                           	MOV		ES,AX
    48 00007C61 B5 00                           	MOV		CH,0		;柱面0
    49 00007C63 B6 00                           	MOV		DH,0		;磁头0
    50 00007C65 B1 02                           	MOV		CL,2		;扇区2
    51 00007C67                                 
    52 00007C67                                 readLoop:
    53 00007C67 BE 0000                         	MOV		SI,0		;代表失败重试次数
    54 00007C6A                                 
    55 00007C6A                                 ;读盘程序段
    56 00007C6A                                 retry:
    57 00007C6A B4 02                           	MOV		AH,0X02		;读盘指令
    58 00007C6C B0 01                           	MOV		AL,1		;读取扇区个数，1个
    59 00007C6E BB 0000                         	MOV		BX,0		
    60 00007C71 B2 00                           	MOV		DL,0X00		;驱动器A
    61 00007C73 CD 13                           	INT		0X13		;调用BIOS
    62 00007C75 73 10                           	JNC 	next		;本次加载成功
    63 00007C77                                 	
    64 00007C77 83 C6 01                        	ADD		SI,1		;否则失败了，SI+1
    65 00007C7A 83 FE 05                        	CMP		SI,5
    66 00007C7D 73 35                           	JAE		error		;失败次数大于5，跳转到error
    67 00007C7F                                 	
    68 00007C7F B4 00                           	MOV		AH,0x00
    69 00007C81 B2 00                           	MOV		DL,0x00		; A驱动器
    70 00007C83 CD 13                           	INT		0x13		; 重置驱动器
    71 00007C85 EB E3                           	JMP		retry
    72 00007C87                                 
    73 00007C87                                 next:
    74 00007C87 8C C0                           	MOV AX,ES			;向内存读取的地址 后移512字节
    75 00007C89 05 0020                         	ADD	AX,0X0020
    76 00007C8C 8E C0                           	MOV	ES,AX
    77 00007C8E                                 	
    78 00007C8E 80 C1 01                        	ADD	CL,1			;扇区加一，直到18
    79 00007C91 80 F9 12                        	CMP	CL,18
    80 00007C94 76 D1                           	JBE	readLoop
    81 00007C96                                 
    82 00007C96 B1 01                           	MOV	CL,1
    83 00007C98 80 C6 01                        	ADD	DH,1
    84 00007C9B 80 FE 02                        	CMP DH,2
    85 00007C9E 72 C7                           	JB	readLoop		;磁头0，1
    86 00007CA0                                 	
    87 00007CA0 B6 00                           	MOV	DH,0
    88 00007CA2 80 C5 01                        	ADD	CH,1
    89 00007CA5 80 FD 0A                        	CMP	CH,CYLS
    90 00007CA8 72 BD                           	JB	readLoop		;读入指定柱面数
    91 00007CAA                                 	
    92 00007CAA 88 2E 0FF0                      	MOV		[0x0ff0],CH	;保存 柱面数到内存,以备以后调用
    93 00007CAE E9 454F                         	JMP		0xc200		;跳转的OsHead 程序
    94 00007CB1                                 	
    95 00007CB1                                 ;---------------------------------------------
    96 00007CB1                                 fin:
    97 00007CB1 F4                              	HLT
    98 00007CB2 EB FD                           	JMP 	fin
    99 00007CB4                                 
   100 00007CB4                                 ;---------------------------------------------
   101 00007CB4                                 error:
   102 00007CB4 BE 7CC9                         	MOV 	SI,errorMsg
   103 00007CB7                                 	
   104 00007CB7                                 putloop:				;显示文字
   105 00007CB7 8A 04                           	MOV		AL,[SI]
   106 00007CB9 83 C6 01                        	ADD		Si,1
   107 00007CBC 3C 00                           	CMP		AL,0
   108 00007CBE 74 F1                           	JE		fin
   109 00007CC0 B4 0E                           	MOV		AH,0x0e
   110 00007CC2 BB 000F                         	MOV 	BX,15
   111 00007CC5 CD 10                           	INT 	0x10
   112 00007CC7                                 	
   113 00007CC7 EB EE                           	JMP		putloop
   114 00007CC9                                 
   115 00007CC9                                 ;---------------------------------------------
   116 00007CC9                                 errorMsg:
   117 00007CC9 0A 0A                           	DB		0x0a, 0x0a		; 换行
   118 00007CCB 4C 6F 61 64 20 65 72 72 6F 72   	DB		"Load error"
   119 00007CD5 0A                              	DB		0x0a			; 换行
   120 00007CD6 00                              	DB		0
   121 00007CD7                                 
   122 00007CD7                                 	
   123 00007CD7                                 ;---------------------------------------------
   124 00007CD7 00 00 00 00 00 00 00 00 00 00   	RESB	0x7dfe-$		; 填充字符
       00007CE1 00 00 00 00 00 00 00 00 00 00 
       00007CEB 00 00 00 00 00 00 00 00 00 00 
       00007CF5 00 00 00 00 00 00 00 00 00 00 
       00007CFF 00 00 00 00 00 00 00 00 00 00 
       00007D09 00 00 00 00 00 00 00 00 00 00 
       00007D13 00 00 00 00 00 00 00 00 00 00 
       00007D1D 00 00 00 00 00 00 00 00 00 00 
       00007D27 00 00 00 00 00 00 00 00 00 00 
       00007D31 00 00 00 00 00 00 00 00 00 00 
       00007D3B 00 00 00 00 00 00 00 00 00 00 
       00007D45 00 00 00 00 00 00 00 00 00 00 
       00007D4F 00 00 00 00 00 00 00 00 00 00 
       00007D59 00 00 00 00 00 00 00 00 00 00 
       00007D63 00 00 00 00 00 00 00 00 00 00 
       00007D6D 00 00 00 00 00 00 00 00 00 00 
       00007D77 00 00 00 00 00 00 00 00 00 00 
       00007D81 00 00 00 00 00 00 00 00 00 00 
       00007D8B 00 00 00 00 00 00 00 00 00 00 
       00007D95 00 00 00 00 00 00 00 00 00 00 
       00007D9F 00 00 00 00 00 00 00 00 00 00 
       00007DA9 00 00 00 00 00 00 00 00 00 00 
       00007DB3 00 00 00 00 00 00 00 00 00 00 
       00007DBD 00 00 00 00 00 00 00 00 00 00 
       00007DC7 00 00 00 00 00 00 00 00 00 00 
       00007DD1 00 00 00 00 00 00 00 00 00 00 
       00007DDB 00 00 00 00 00 00 00 00 00 00 
       00007DE5 00 00 00 00 00 00 00 00 00 00 
       00007DEF 00 00 00 00 00 00 00 00 00 00 
       00007DF9 00 00 00 00 00 
   125 00007DFE 55 AA                           	DB		0x55, 0xaa			;最后两个字节代表启动扇区
   126 00007E00                                 
   127 00007E00                                 
   128 00007E00                                 
   129 00007E00                                 
   130 00007E00                                 
   131 00007E00                                 
   132 00007E00                                 
   133 00007E00                                 
   134 00007E00                                 
   135 00007E00                                 
